# 第四章 网络/IP层

网络层：实现终端节点的通信，提供阻塞控制，为数据包选择路由，实现数据包的选路和转发。

常见协议有：IP, ICMP, ARP, RARP, AKP, UUCP。又称为IP层，足以说明IP协议在该层的重要性。

在这一层数据的单位是数据包。

## 4.1 IP协议

IP是一种 「不可靠」的 「端到端」的数据包 「传输服务」，主要实现两个功能：数据传输 和 数据分片。

IP协议是TCP/IP协议族的核心协议，也是socket网络编程的基础之一。它为上层提供无状态、无连接、不可靠的服务。

- 无状态：指IP通信双方不同步传输数据的状态信息，因此所有IP数据报的发送，传输，接收都是相互独立的。这种服务最大缺点是无法处理乱序和重复的IP数据报。优点是简单高效，和UDP协议与HTTP协议相同，都是无状态协议。

- 无连接：指IP通信双方都不长久的维持对方的任何信息。这表示上层协议每次发送数据，都需要明确指定对方的IP地址。

- 不可靠：指IP协议中的IP数据报不能准确到达接收端，只是会尽最大努力。一旦发送失败，就通知上层协议，而不会试图重发。

IP 大致分为三大作用模块，它们是 IP 寻址、路由（最终节点为止的转发）以及 IP 分包与组包。

IP协议有IPv4和IPv6，我们重点学IPv4。

### 4.1.1 IP协议头部格式

下面描述的仅仅是头部结构，整个IP数据报文有头部结构和数据部分。

IPv4头部结构如下：

![](D:\Java\笔记\图片\5-15【网络模型-网络层】\1-2IPv4头部结构.png)

IP协议首部与TCP协议首部非常相似，如果没有特殊情况，都是20个字节，因此我们也经常会把两者放在一起称为TCP/IP协议。下面将IP协议首部每个字段都详细介绍一下：

- 4位版本号：用来指定IP协议的版本，IPV4的版本号就是4，用4位来标识就是0100。

- 4位头部长度：表明IP头部结构的大小，标识头部最多有多少个4字节，因此单位是4字节。一共有四个比特位，因为4个比特位最大值是15，所以IPv4最大头部长度可表示有15个4字节=60字节。在默认情况下，该字段被设置为5，所以默认IP首部20字节，所以选项最多的话是40字节。

- 8位服务类型：前三位表示优先度（已经弃用），第4位表示最小延迟、第5位表示最大吞吐量、第6位表示最高可用性、第7位表示最小费用(最小代价)，这四位互相冲突，只能选择一个。需要根据不同情况进行选择，如果是SSH/TELNET这类远端登录，那么就应该选择最小延时，如果是FTP类型的程序，则应该选择最大吞吐量；第8位是保留位，目前没有使用，必须填0。

  ![](D:\Java\笔记\图片\5-15【网络模型-网络层】\1-3IPv3头部结构8位服务类型.png)

- 16位总长度：表示IP首部和后面携带的数据部分一共有多少个字节。该字段有16个比特位，因此IP数据报整体最大长度为2的16次方，65535个字节。

- 16位标识：数据报的唯一标识。同一个数据报的所有分片中具有相同的标识。如果一份IP报文在数据链路层被分片，那么每一片的该字段应该都是相同值。帮助对端主机在接收后进行分片重组。

- 3位标志：第一位保留，现在不使用，未来如果需要的话再使用，必须填0。第二位用来指明是否可以分片，如果为0则可以分片，如果为1则不能分片，但是假如一个IP报文禁止分片且长度还大于了MTU（Maximum Transmission Unit最大传输单元），则该本文只能被丢弃。第三位为1表示它是分片中段的报文，即后续还有分片报文，如果第三位为0则表示这是最后一片。

- 13位片偏移：该字段表示分片相对于原始IP报文开始处的偏移量，其实就是表示当前分片在原报文中所处的位置，第一个分片对应值为0。由于该字段总共13个比特位，因此最多可以表示2 ^ 13即8192个相对位置。单位为8字节，所以最大可以表示8192 * 8 = 65536个字节的位置。

- 8位生存时间：TTL（Time To Live）数据报到达目的地的最大报文跳数，一般为64。每次经过一个路由，TTL–1，如果TTL == 0时还没到达目的地，那么这个报文就会被丢弃。并向源端发送一个ICMP差错报文，目的防止数据报陷入路由循环。这个字段主要是为了防止出现路由循环，数据包在一个循环中一直转发，浪费网络资源。

- 8位协议：表示IP的上层是什么协议，我们熟知的TCP、UDP、ICMP等都是在IP上层的。

- 16位头部校验和：由发送端填充，接收端对其使用CRC算法校验IP数据报头部（仅校验头部）在传输过程中是否损坏，如果损坏直接丢弃，它只校验IP头部，不校验下面的内容，因为内容部分的校验是上层传输层TCPP）需要考虑的，IP协议只要发现首部有问题就直接丢弃该报文。

- 32位源IP地址：表示发送端的IP。

- 32位目的IP地址：表示接收端的IP。

- 选项字段：不定长，最大可以到40个字节。，可用的IP选项如下：

  - 记录路由：将数据包经由的所有路由器IP填入该段。
  - 时间戳：将数据报在每个路由器被转发时的时间填入该段。
  - 松散源路由选择：指定路由器IP地址列表，数据报发送过程中必须经过其中所有路由器
  - 严格源路由选择：类似上面，数据报只能经过被指定的路由器。

### 4.1.2 IP地址

在计算机通信中，为了识别通信对端，必须要有一个类似于地址的识别码进行标识。在数据链路中的 MAC 地址正是用来标识同一个链路中不同计算机的一种识别码。作为网络层的 IP ,也有这种地址信息，一般叫做 IP 地址。

IPV4中我们由32个二进制位来表示IP地址，习惯上我们用分成四段的十进制数表示IP地址，即将32位IP地址每8位一组，分成4组，组间用’ . '进行分隔，再将每组转换为十进制。从0.0.0.0到255.255.255.255，地址分为两个部分，前一部分代表网络，后一部分代表主机。

在IPV4标准下最多有2 ^ 32 = 4292967296个IP地址，但是能被人们使用的远远不足这个数字。（比如某些IP地址是有特殊作用被预留的，某些设备如路由器会占有多个IP地址）。因此就弄出来了IPv6，之后再说。

IP地址由网络标识（网络地址）和主机标识（主机地址）两部分组成。

* 查找到一个IP地址的过程就像旅游一样，想要去天安门玩，不可能直接坐高铁到达天安门。一定是先抵达北京市（目的网络），再通过北京市内的交通抵达天安门（目的主机）。
* 因此我们在路由选择时，应该先找到目标主机所在的局域网，再在该局域网中找到目标主机。这种方式可以快速帮我们定位到目标局域网，在局域网内搜索目标主机就比在茫茫的网络中找一台主机要快速多了。

网络号：保证互相连接的两个网段具有不同的标识。

主机号：保证在同一个网段中，两台主机具有不同的标识。

IP地址划分为五个级别，分别为A类、B类、C类、D类和E类（一直没有使用过），所以目前我们所能见到的**IP地址只有A、B、C、D四类。划分的依据就是IP地址从第1位到第4位的比特位。**

![](D:\Java\笔记\图片\5-15【网络模型-网络层】\1-4IP地址分类.png)

- A类地址：0.0.0.0 ~ 127.255.255.255。该类IP地址的最前面为“0”，即前八位最大为0 1111111 (127 十进制)，但是127被用作测试使用，所以最大为126，所以地址的网络号取值于1~126之间。一般用于大型网络。
- B类地址：128.0.0.0 ~ 191.255.255.255。该类IP地址的最前面为“10”，即前八位最小值为128，最大值为191。一般用于中等规模网络。
- C类地址：192.0.0.0 ~ 223.255.255.255。该类IP地址最前面为“110”，即前八位最小值为192，最大值为223。一般用于小型网络。

- D类地址：224.0.0.0 ~ 239.255.255.255。该类IP地址最前面为“1110”，即前八位最小值为224，最大值为239。一般用于多路广播用户。
- E类地址：240.0.0.0 ~ 247.255.255.255

我们可以发现，A、B、C、D类地址的网络号所占比特位逐渐增加，而主机号所占的比特位在逐渐减少。这就意味着上述四类地址中，一类地址中的子网数量越来越多，但是子网中可以连接的主机变得越来越少。

以国内一所普通高校为例，全校师生大约3万人，如果每个人都有一台笔记本电脑需要连接到校园局域网中，有些同学还会有一些平板电脑等其他需要连接网络的终端设备，那么在申请网络时就应该以5~6万个IP地址去申请，如果使用A类地址，那么主机号24位会产生2 ^ 24 = 16777216个IP地址，远远超过实际所需要的，如果使用C类地址，则只有2 ^ 8 = 256个IP地址，远少于所需IP地址，所以最合适的是B类地址，有2 ^ 16 = 65536个IP地址。这个例子也告诉我们，IP地址不能太多，会造成大量浪费；也不能太少，否则很多设备会无法连接网络。

#### 广播地址

- 广播地址用于在同一个链路中相互连接的主机之间发送数据包。将 IP 地址中的主机地址部分全部设置为 1，就成了广播地址。
- 广播分为本地广播和直接广播两种。在本网络内的广播叫做本地广播；在不同网络之间的广播叫做直接广播。

这个广播地址可以给同一个链路中互相连接的所有主机发送数据包。

#### IP多播

- 多播用于将包发送给特定组内的所有主机。由于其直接使用 IP 地址，因此也不存在可靠传输。
- 相比于广播，多播既可以穿透路由器，又可以实现只给那些必要的组发送数据包。

多播使用 D 类地址。因此，如果从首位开始到第 4 位是 “1110”，就可以认为是多播地址。而剩下的 28 位可以成为多播的组编号。

此外， 对于多播，所有的主机（路由器以外的主机和终端主机）必须属于 224.0.0.1 的组，所有的路由器必须属于 224.0.0.2 的组。

#### 子网掩码

随着Internet的发展，使用前四位是否为1来分类的方案弊端开始显现：那就是很多子网的申请者都会去申请B类网络地址，因为A类根本用不完，而C类不够用。导致B类的网络地址很快就被分配完了。而申请了A类的网络又会浪费大量的IP地址。在这种情况下，**人们提出了新的划分方案：CIDR（Classless Interdomain Routing无类型域间选路）**

- 引入子网掩码来区分网络号和主机号
- 子网掩码也是一个32位的正整数，但结尾通常是一串0
- 将IP地址与子网掩码进行`&`操作，所得结果就是网络号
- 网络号和主机号的划分就与这个IP地址是A类、B类还是C类无关了

举两个例子帮助理解通过子网掩码来划分网络号和主机号

|    IP地址     |               二进制表达                |
| :-----------: | :-------------------------------------: |
| 140.252.20.68 | 1000 1100 1111 1100 0001 0100 0100 0100 |

|   子网掩码    |               二进制表达                |
| :-----------: | :-------------------------------------: |
| 255.255.255.0 | 1111 1111 1111 1111 1111 1111 0000 0000 |

将IP地址与子网掩码进行按位与操作后得到`1000 1100 1111 1100 0001 0100 0000 0000`，再转化为方便人们使用的点分十进制为`140.252.20.0`，这就是该子网的网络号了。并且它的子网掩码末尾的8个比特位为0，这个子网可以表示2 ^ 8 = 256台主机，因此这个子网的地址范围是`140.252.20.0 ~ 140.252.20.255`。

|      IP地址      |               二进制表达                |
| :--------------: | :-------------------------------------: |
| 140. 252. 20. 68 | 1000 1100 1111 1100 0001 0100 0100 0100 |

|    子网掩码     |               二进制表达                |
| :-------------: | :-------------------------------------: |
| 255.255.255.240 | 1111 1111 1111 1111 1111 1111 1111 0000 |

将IP地址与子网掩码进行按位与操作后得到`1000 1100 1111 1100 0001 0110 0100 0000`，即该子网的网络号，同样转换成常用的点分十进制为`140.252.20.64`，它的子网掩码末尾的4个比特位为0，这个子网可以表示2 ^ 4 = 16台主机，因此这个子网的地址范围就是`140.252.20.64 ~ 140.252.20.79`。

知道“子网掩码”，我们就能判断，任意两个IP地址是否处于同一个子网络，方法是将两个IP地址与子网掩码分别进行AND运算，结果相同则说明在同一个子网络中。这是因为将IP地址与子网掩码进行`&`操作，所得结果就是网络号，网络号相同就是在同一个子网络。

例如：已知IP地址172.16.254.1和172.16.254.233的子网掩码都是255.255.255.0。

|   IP地址    |               二进制表达                |
| :---------: | :-------------------------------------: |
| 172.16.10.1 | 1010 1100 0001 0000 0000 1010 0000 0001 |

|   子网掩码    |               二进制表达                |
| :-----------: | :-------------------------------------: |
| 255.255.255.0 | 1111 1111 1111 1111 1111 1111 0000 0000 |

|   IP地址    |               二进制表达                |
| :---------: | :-------------------------------------: |
| 172.16.10.2 | 1010 1100 0001 0000 0000 1010 0000 0010 |

两者与子网掩码分别进行AND运算，结果都是172.16.254.0，因此它们在同一个子网络。

#### 特殊的IP地址

- 将IP地址中的主机地址全设置为0，即该局域网的网络号，这个IP地址代表这个局域网。
- 将IP地址中的主机地址全设置为1，可以变成广播地址，这个广播地址可以给同一个链路中互相连接的所有主机发送数据包
- 127.*的IP地址用于本地环回测试，通常是127.0.0.1，或者localhost。

假如某个大学要在校园内部组建一个局域网，只实现校园内部的网络通信而不与外界任何一台机器进行通信，那么理论上2 ^ 32个IP地址都可以使用，因为只在这个局域网中，不会出现相同的IP地址。不过RFC1918规定了组建局域网的私有IP地址的规范：

- 10.* 前8位是网络号，共有16,777,216个地址
- 172.16.*~172.31.* 前12位是网络号，共有1,048,576个地址
- 192.168.* 前16位是网络号，共有65,536个地址

上述范围内的IP地址都是私有IP，不在上述范围内的IP则为全局IP地址（公网IP地址）。

### 4.1.3 IP路由

发送数据包时所使用的地址是网络层的地址，即 IP 地址。然而仅仅有 IP 地址还不足以实现将数据包发送到对端目标地址，在数据发送过程中还需要类似于“指明路由器或主机”的信息，以便真正发往目标地址。保存这种信息的就是路由控制表。

当一个 IP 包从一台计算机被发送，它会到达一个 IP 路由器。IP 路由器负责将这个包路由至它的目的地，直接地或者通过其他的路由器。

在一个相同的通信中，一个包所经由的路径可能会和其他的包不同。而路由器负责根据通信量、网络中的错误或者其他参数来进行正确地寻址。

### 4.1.4 数据分片

数据分片也叫做IP分包。

当IP数据报的长度超过帧的MTU时，它将被分片传输。分片可能发生在发送端，也可能发生在中转路由器上，而且在传输过程中可能被多次分片，只有在最终目标机器上，这些分片才会在内核中被IP模块重新组装。IP头部中的数据报标识、标志、和片偏移为IP的分片和重组提供了足够的信息。

MTU（Maximum Transmission Unit最大传输单元）是在IP层下面的MAC协议中的概念，MAC协议我们可以理解为是物理层的一些协议，它位于IP协议的下层。

那么在发送数据时相当于是`用户数据 + 应用层协议报头（如HTTP请求报头）`作为有效载荷交给传输层（如TCP协议），TCP协议再将`TCP报头 + 应用层传来的数据`下交给IP层，IP层再将`IP协议首部 + TCP层传来的TCP报文`交付给MAC帧。因此每个MAC帧其实是`IP协议首部 + IP层的有效载荷`。而MAC帧是有长度限制的，所以就要求IP数据报向下交付时并不是随心所欲想发多长就发多长，如果MAC帧要求MTU为1500字节，而IP数据包总长度有2000字节，那么就需要分片，将原有的IP数据包分成两片，依次发送，对端的主机在接收后，由对端的IP层再完成组装。

> 我们在Linux环境下可以使用ifconfig命令查看到MTU。

分片机制也有它的不足。如路由器的处理负荷加重之类。因此，只要允许，是不希望由路由器进行 IP 数据包的分片处理的。

为了应对分片机制的不足，“路径 MTU 发现” 技术应运而生。路径 MTU 指的是，从发送端主机到接收端主机之间不需要分片是最大 MTU 的大小。即路径中存在的所有数据链路中最小的 MTU 。

进行路径 MTU 发现，就可以避免在中途的路由器上进行分片处理，也可以在 TCP 中发送更大的包。

### 4.1.5 IPv6

IPv6（IP version 6）是为了根本解决 IPv4 地址耗尽的问题而被标准化的网际协议。IPv4 的地址长度为 4 个 8 位字节，即 32 比特。而 IPv6 的地址长度则是原来的 4 倍，即 128 比特，一般写成 8 个 16 位字节。

IPv6的特点：

- IP 得知的扩大与路由控制表的聚合。
- 性能提升。包首部长度采用固定的值（40字节），不再采用首部检验码。简化首部结构，减轻路由器负担。路由器不再做分片处理。
- 支持即插即用功能。即使没有DHCP服务器也可以实现自动分配 IP 地址。
- 采用认证与加密功能。应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能。
- 多播、Mobile IP 成为扩展功能。

## 4.2 ARP/RARP

只要确定了 IP 地址，就可以向这个目标地址发送 IP 数据报。然而，在底层数据链路层，进行实际通信时却有必要了解每个 IP 地址所对应的 MAC 地址。

ARP 是一种解决地址问题的协议。以目标 IP 地址为线索，用来定位下一个应该接收数据分包的网络设备对应的 MAC 地址。不过 ARP 只适用于 IPv4，不能用于 IPv6。IPv6 中可以用 ICMPv6 替代 ARP 发送邻居探索消息。

- APR协议：解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题。ARP是在仅知道主机的IP地址时确定其物理地址的协议。广播的方式发送数据包，获取目标主机的mac地址。

- RARP协议：解决同一个局域网上的主机或路由器的硬件地址和IP地址的映射问题。将MAC物理地址转换成IP地址。将 ARP 反过来，从 MAC 地址定位 IP 地址的一种协议。


## 4.3 ICMP

ICMP 的主要功能包括，确认 IP 包是否成功送达目标地址，通知在发送过程当中 IP 包被废弃的具体原因，改善网络设置等。

IPv4 中 ICMP 仅作为一个辅助作用支持 IPv4。也就是说，在 IPv4 时期，即使没有 ICMP，仍然可以实现 IP 通信。然而，在 IPv6 中，ICMP 的作用被扩大，如果没有 ICMPv6，IPv6 就无法进行正常通信。

# 第五章 网络接口层

没有具体实现